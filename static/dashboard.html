<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="/static/vue.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›æµ‹ä»ªè¡¨æ¿ - Homalos Data Center</title>
    
    <!-- å¼•å…¥ ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .metric-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .metric-value {
            font-size: 36px;
            font-weight: bold;
            color: #333;
        }
        
        .metric-value.positive {
            color: #00b09b;
        }
        
        .metric-value.negative {
            color: #ff416c;
        }
        
        .charts-container {
            padding: 30px;
        }
        
        .chart-box {
            margin-bottom: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            padding: 20px;
        }
        
        .chart-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .chart {
            width: 100%;
            height: 500px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #ff416c;
        }
        
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ“Š å›æµ‹ä»ªè¡¨æ¿</h1>
            <p>Homalos Data Center - äº¤äº’å¼å¯è§†åŒ–åˆ†æ</p>
        </div>
        
        <!-- ç»©æ•ˆæŒ‡æ ‡å¡ç‰‡ -->
        <div class="metrics-grid" id="metrics">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        
        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="charts-container">
            <!-- äº¤æ˜“ç‚¹ä½å›¾ -->
            <div class="chart-box">
                <div class="chart-title">ğŸ“ˆ ä»·æ ¼ä¸äº¤æ˜“ç‚¹ä½</div>
                <div id="tradeChart" class="chart"></div>
            </div>
            
            <!-- èµ„é‡‘æ›²çº¿å›¾ -->
            <div class="chart-box">
                <div class="chart-title">ğŸ’° èµ„é‡‘æ›²çº¿</div>
                <div id="equityChart" class="chart"></div>
            </div>
            
            <!-- å›æ’¤æ›²çº¿å›¾ -->
            <div class="chart-box">
                <div class="chart-title">ğŸ“‰ å›æ’¤æ›²çº¿</div>
                <div id="drawdownChart" class="chart"></div>
            </div>
            
            <!-- æŒä»“å˜åŒ–å›¾ -->
            <div class="chart-box">
                <div class="chart-title">ğŸ“Š æŒä»“å˜åŒ–</div>
                <div id="positionChart" class="chart"></div>
            </div>
        </div>
        
        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="controls">
            <button class="btn" onclick="location.reload()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <button class="btn" onclick="exportData()">ğŸ’¾ å¯¼å‡ºæ•°æ®</button>
            <button class="btn" onclick="window.open('/docs')">ğŸ“š APIæ–‡æ¡£</button>
        </div>
    </div>
    
    <script>
        // åˆå§‹åŒ–å›¾è¡¨
        const tradeChart = echarts.init(document.getElementById('tradeChart'));
        const equityChart = echarts.init(document.getElementById('equityChart'));
        const drawdownChart = echarts.init(document.getElementById('drawdownChart'));
        const positionChart = echarts.init(document.getElementById('positionChart'));
        
        // åŠ è½½æœ€æ–°çš„å›æµ‹æ•°æ®
        async function loadBacktestData() {
            try {
                // è·å–å›æµ‹ç»“æœåˆ—è¡¨
                const listResponse = await fetch('/backtest/list');
                const listData = await listResponse.json();
                
                if (listData.results.length === 0) {
                    document.getElementById('metrics').innerHTML = '<div class="error">æš‚æ— å›æµ‹æ•°æ®<br><small>è¯·å…ˆè¿è¡Œå›æµ‹ï¼špython examples/run_backtest.py</small></div>';
                    return;
                }
                
                // è·å–æœ€æ–°çš„å›æµ‹æ•°æ®
                const latestFile = listData.results[0].filename;
                const dataResponse = await fetch(`/backtest/export/${latestFile}`);
                const data = await dataResponse.json();
                
                // æ¸²æŸ“æŒ‡æ ‡å¡ç‰‡
                renderMetrics(data.metrics);
                
                // æ¸²æŸ“å›¾è¡¨
                renderTradeChart(data.account_history);
                renderEquityChart(data.account_history);
                renderDrawdownChart(data.account_history);
                renderPositionChart(data.account_history);
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                document.getElementById('metrics').innerHTML = '<div class="error">æ•°æ®åŠ è½½å¤±è´¥<br><small>' + error.message + '</small></div>';
            }
        }
        
        // æ¸²æŸ“æŒ‡æ ‡å¡ç‰‡
        function renderMetrics(metrics) {
            const totalReturn = metrics['Total Return'] || 0;
            const sharpeRatio = metrics['Sharpe Ratio'] || 0;
            const maxDrawdown = metrics['Max Drawdown'] || 0;
            const finalEquity = metrics['Final Equity'] || 0;
            
            const html = `
                <div class="metric-card">
                    <div class="metric-label">æ€»æ”¶ç›Šç‡</div>
                    <div class="metric-value ${totalReturn > 0 ? 'positive' : 'negative'}">
                        ${(totalReturn * 100).toFixed(2)}%
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">å¤æ™®æ¯”ç‡</div>
                    <div class="metric-value">${sharpeRatio.toFixed(2)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">æœ€å¤§å›æ’¤</div>
                    <div class="metric-value negative">${(maxDrawdown * 100).toFixed(2)}%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">æœ€ç»ˆæƒç›Š</div>
                    <div class="metric-value">${finalEquity.toLocaleString('zh-CN', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                </div>
            `;
            
            document.getElementById('metrics').innerHTML = html;
        }
        
        // æ¸²æŸ“äº¤æ˜“ç‚¹ä½å›¾
        function renderTradeChart(history) {
            const times = history.map(h => h.datetime);
            const prices = history.map(h => h.price);
            const buys = history.filter(h => h.side === 'BUY');
            const sells = history.filter(h => h.side === 'SELL');
            
            const buyData = buys.map(h => [h.datetime, h.price]);
            const sellData = sells.map(h => [h.datetime, h.price]);
            
            // è®¡ç®—ä»·æ ¼èŒƒå›´ï¼Œä¼˜åŒ–Yè½´æ˜¾ç¤º
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            const priceRange = maxPrice - minPrice;
            const padding = priceRange * 0.1; // ä¸Šä¸‹ç•™10%ç©ºé—´
            
            const option = {
                title: { text: 'ä»·æ ¼ä¸äº¤æ˜“ç‚¹ä½', left: 'center' },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    formatter: function(params) {
                        let result = params[0].name + '<br/>';
                        params.forEach(param => {
                            if (param.value != null) {
                                result += param.marker + param.seriesName + ': ' + param.value + '<br/>';
                            }
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['ä»·æ ¼', 'ä¹°å…¥', 'å–å‡º'],
                    top: '8%'
                },
                grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: times,
                    axisLabel: {
                        rotate: 45,
                        interval: Math.floor(times.length / 10)
                    }
                },
                yAxis: { 
                    type: 'value',
                    scale: true,  // ä¸ä»0å¼€å§‹
                    min: Math.floor(minPrice - padding),
                    max: Math.ceil(maxPrice + padding),
                    splitNumber: 8
                },
                dataZoom: [
                    { type: 'slider', start: 0, end: 100 },
                    { type: 'inside' }
                ],
                series: [
                    {
                        name: 'ä»·æ ¼',
                        type: 'line',
                        data: prices,
                        smooth: false,
                        lineStyle: { width: 1.5, color: '#888' },
                        showSymbol: false
                    },
                    {
                        name: 'ä¹°å…¥',
                        type: 'scatter',
                        data: buyData,
                        symbol: 'triangle',
                        symbolSize: 15,
                        itemStyle: { color: '#00DA3C' },
                        z: 10
                    },
                    {
                        name: 'å–å‡º',
                        type: 'scatter',
                        data: sellData,
                        symbol: 'pin',
                        symbolSize: 15,
                        itemStyle: { color: '#EC0000' },
                        z: 10
                    }
                ]
            };
            
            tradeChart.setOption(option);
        }
        
        // æ¸²æŸ“èµ„é‡‘æ›²çº¿å›¾
        function renderEquityChart(history) {
            const times = history.map(h => h.datetime);
            const equity = history.map(h => h.cash);
            
            // è®¡ç®—èµ„é‡‘èŒƒå›´ï¼Œä¼˜åŒ–Yè½´
            const minEquity = Math.min(...equity);
            const maxEquity = Math.max(...equity);
            const equityRange = maxEquity - minEquity;
            const padding = equityRange > 0 ? equityRange * 0.2 : 1000; // ä¸Šä¸‹ç•™20%ç©ºé—´
            
            const option = {
                title: { text: 'èµ„é‡‘æ›²çº¿', left: 'center' },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        return params[0].name + '<br/>èµ„é‡‘: Â¥' + params[0].value.toLocaleString('zh-CN');
                    }
                },
                legend: { data: ['èµ„é‡‘'], top: '8%' },
                grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: times,
                    boundaryGap: false,
                    axisLabel: {
                        rotate: 45,
                        interval: Math.floor(times.length / 10)
                    }
                },
                yAxis: {
                    type: 'value',
                    scale: true,  // ä¸ä»0å¼€å§‹
                    min: Math.floor(minEquity - padding),
                    max: Math.ceil(maxEquity + padding),
                    splitNumber: 6,
                    axisLabel: {
                        formatter: function(value) {
                            return 'Â¥' + value.toLocaleString('zh-CN');
                        }
                    }
                },
                dataZoom: [
                    { type: 'slider', start: 0, end: 100 },
                    { type: 'inside' }
                ],
                series: [{
                    name: 'èµ„é‡‘',
                    type: 'line',
                    data: equity,
                    smooth: true,
                    lineStyle: { width: 3, color: '#3398DB' },
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0, y: 0, x2: 0, y2: 1,
                            colorStops: [
                                { offset: 0, color: 'rgba(51,152,219,0.5)' },
                                { offset: 1, color: 'rgba(51,152,219,0.1)' }
                            ]
                        }
                    },
                    showSymbol: false
                }]
            };
            
            equityChart.setOption(option);
        }
        
        // æ¸²æŸ“å›æ’¤æ›²çº¿å›¾
        function renderDrawdownChart(history) {
            const times = history.map(h => h.datetime);
            const equity = history.map(h => h.cash);
            
            // è®¡ç®—å›æ’¤
            let cummax = equity[0];
            const drawdown = equity.map(val => {
                cummax = Math.max(cummax, val);
                return parseFloat(((val - cummax) / cummax * 100).toFixed(2));
            });
            
            const minDrawdown = Math.min(...drawdown);
            const maxDrawdown = Math.max(...drawdown);
            
            const option = {
                title: { 
                    text: 'å›æ’¤æ›²çº¿', 
                    left: 'center',
                    subtext: `æœ€å¤§å›æ’¤: ${minDrawdown.toFixed(2)}%`
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        return params[0].name + '<br/>å›æ’¤: ' + params[0].value + '%';
                    }
                },
                legend: { data: ['å›æ’¤'], top: '8%' },
                grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: times,
                    boundaryGap: false,
                    axisLabel: {
                        rotate: 45,
                        interval: Math.floor(times.length / 10)
                    }
                },
                yAxis: {
                    type: 'value',
                    scale: true,
                    min: function(value) {
                        return Math.floor(minDrawdown - 0.1);
                    },
                    max: 0.5,  // å›ºå®šä¸Šé™ä¸º0.5%
                    splitNumber: 6,
                    axisLabel: { formatter: '{value}%' }
                },
                dataZoom: [
                    { type: 'slider', start: 0, end: 100 },
                    { type: 'inside' }
                ],
                series: [{
                    name: 'å›æ’¤',
                    type: 'line',
                    data: drawdown,
                    smooth: true,
                    lineStyle: { width: 3, color: '#EC0000' },
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0, y: 0, x2: 0, y2: 1,
                            colorStops: [
                                { offset: 0, color: 'rgba(236,0,0,0.3)' },
                                { offset: 1, color: 'rgba(236,0,0,0.05)' }
                            ]
                        }
                    },
                    showSymbol: false
                }]
            };
            
            drawdownChart.setOption(option);
        }
        
        // æ¸²æŸ“æŒä»“å˜åŒ–å›¾
        function renderPositionChart(history) {
            const times = history.map(h => h.datetime);
            const positions = history.map(h => h.position || 0);
            
            const option = {
                title: { text: 'æŒä»“å˜åŒ–', left: 'center' },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        return params[0].name + '<br/>æŒä»“: ' + params[0].value;
                    }
                },
                legend: { data: ['æŒä»“'], top: '8%' },
                grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: times,
                    axisLabel: {
                        rotate: 45,
                        interval: Math.floor(times.length / 10)
                    }
                },
                yAxis: { type: 'value' },
                dataZoom: [
                    { type: 'slider', start: 0, end: 100 },
                    { type: 'inside' }
                ],
                series: [{
                    name: 'æŒä»“',
                    type: 'bar',
                    data: positions,
                    itemStyle: {
                        color: function(params) {
                            return params.value > 0 ? '#00DA3C' : params.value < 0 ? '#EC0000' : '#888';
                        }
                    }
                }]
            };
            
            positionChart.setOption(option);
        }
        
        // å¯¼å‡ºæ•°æ®
        function exportData() {
            alert('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...');
        }
        
        // å“åº”å¼è°ƒæ•´
        window.addEventListener('resize', function() {
            tradeChart.resize();
            equityChart.resize();
            drawdownChart.resize();
            positionChart.resize();
        });
        
        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        loadBacktestData();
    </script>
</body>
</html>

